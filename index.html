<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html">

<head>
    <meta charset="utf-8">

    <title>Testing OSGi the "groovy" way</title>

    <meta name="description" content="Testing OSGi the &ldquo;groovy&ldquo; way">
    <meta name="author" content="Lars Pfannenschmidt">
    <meta name="author" content="Dennis Nobel">

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/night.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
        document.write('<link rel="stylesheet" href="css/print/' + ( window.location.search.match(/print-pdf/gi) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">');
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

<div class="reveal">

<!-- Any section element inside of this container is displayed as a slide -->
<div class="slides">
<section>
    <p>EclipseCon Europe 2013</p>
    <h1> Testing OSGi the <br/>"<span class="groovy-bluex">groovy</span>" way</h1>
    <p>Lars Pfannenschmidt & Dennis Nobel</p>
</section>

<section>
    <h2> Lars Pfannenschmidt</h2>
    <ul>
        <li>Senior Software Engineer at <s>Level Up Analytics</s> Intuit
        </li>
        <li>Founder of <a href="https://twitter.com/mobilecgn">@mobilecgn</a></li>
    </ul>

</section>

<section>
    <h2>Dennis Nobel</h2>
    <ul>
        <li>IT Consultant at itemis AG <a href="https://twitter.com/itemis">@itemis</a></li>
        <li>Java, Web and OSGi Developer</li>
    </ul>
</section>

<section>
    <h1>Imagine<h1><h2>writing tests would make fun...</h2>
</section>
    
<section>

    <section>
        <h1>Question 1:</h1>
        <h2>Do you test your OSGi components?</h2>
    </section>
    
    <section>
        <h1>Question 2:</h1>
        <h2>Are you using Groovy?</h2>
    </section>

</section>

<section>
    <h2>Our Testing Story</h2>

    <h3></h3>
    <ul class="fragment">
        <li>Embedded Device with CVM (~Java 1.4)</li>
        <li>OSGi framework (Prosyst mBS)</li>
        <li>Development with Eclipse</li>
        <li>CI Build with Maven and Tycho</li>
    </ul>
</section>
<section>

    <section>
        <h2>How to write our tests?</h2>
    </section>

    <section>
        <h2>Test Requirements</h2>
        <!---- We have to write a CDC compliant bundle, but why must the test stick to this limitiation? -->
        <ul>
            <li>Easy to write</li>
            <li>Modern language</li>
            <li>Type-safe access to Java classes</li>
            <li>Easy mocking</li>
            <li>Executable in Eclipse and Maven CI build</li>
            <li>Good IDE support</li>
            <li>No side effects for production code</li>
        </ul>
    </section>

    <section>
        <h1>Java?</h1>

        <h2>Modern language?</h2>
        <h2 class="fragment">Not really...</h2>

    </section>

    <section>
        <img src="img/groovy-logo.png">
    </section>

    <section>
        <h2>What? Why Groovy?</h2>
    </section>

    <section>
        <img alt="success-kid" src="img/success_kid.jpg">
        <h2>Because we can!</h2>
    </section>
    
    <section>
        <h1>Groovy</h1>
        <ul>
            <li>JVM Language</li>
            <li>Syntax Sugar</li>
            <li>Closures</li>
            <li>Less "Chatty"</li>
        </ul>
    </section>
</section>

<section>
	<h2>Groovy JUnit Test</h2>
    <p>Type inference, readable asserts, syntax sugar and more:</p>
	<pre>
	   <code data-trim class="java">
@Test
void 'Build pizza with BBQ sauce only'() {
    
    def pizza = PizzaBuilder.newPizza()
                .withSauce(BBQ)
                .build()

    assertThat pizza.sauce, is(BBQ)
    
}
	   </code>
    </pre>
</section>
    
<section>
    <section>
        <h2>How to test our OSGi Services?</h2>
    </section>

    <section>
        <h2>Pizza Service Sample</h2>
        <p>Services: PizzaService &#8594; PaymentService</p>
        <pre>
            <code data-trim class="java">
public class PizzaServiceImpl implements PizzaService {

    @Override
    public void placeOrder(final Order order) {
        ...
        creditCardPaymentService.handleTransaction(...);
        ...
    }
    
}
            </code>
        </pre>
    </section>

    <section>
        <h1>Unit Tests</h1>
        <div>
        <ul class="posneg">
            <li><span>+</span> Executed fast</li>
            <li><span>+</span> Focussed on the component</li>        
            <li><span>-</span> No OSGi Runtime features</li>
            <li><span>-</span> Dependencies must be mocked</li>
            <li><span>-</span> No testing of declarative OSGi parts</li>
        </ul>
        </div>
    </section>

    <section>
        <h1>System Tests</h1>
        <ul class="posneg">
            <li><span>+</span> Cover complete system</li>
            <li><span>+</span> Real target environment</li>
            <li><span>+</span> No mocking or special configuration</li>
            <li><span>-</span> Embedded device is needed (high execution effort)</li>
            <li><span>-</span> Slow execution</li>
            <li><span>-</span> Not focussed</li>
            <!--li><span>-</span> Deterministic configuration</li-->
        </ul>
    </section>
    
    <section>
        <h1>In-Container Tests</h1>
        <ul>
            <li>Executed in OSGi environment</li>
            <li>Focussed on the component</li>
            <li>Testing of declarative OSGi parts</li>
            <li>Only partial mocking</li>
        </ul>
    </section>
    
    <section>
        <h2>...we can not run Groovy in CVM</h2>
    </section>
    
    <section>
        <h2>Why not use</h2>
        <h1>equinox</h1>
        <h2>with a modern JVM?</h2>
    </section>
    
</section>

<section>
    <section>
        <h1>Groovy</h1>
        <h2>In-Container Testing with equinox</h2>
    </section>
    <section>
        <h2>Mocking</h2>
        <p>Simply transform a map to a proxy:</p>
        <pre>
            <code data-trim class="java">
def paymentService = [
    handleTransaction: { String companyId, long creditCardNumber ->
        assertThat companyId, is(equalTo('LUIGIS_PIZZA_SERVICE'))
        transactionCalled = true
    }
] as CreditCardPaymentService
            </code>
        </pre>
    </section>

    <section>
        <h2>Register OSGi service mocks (1)</h2>

        <pre>
            <code data-trim class="java">
class PizzaServiceTest extends OSGiTest {

    @Override
    protected BundleContext getBundleContext() {
        Activator.context
    }
    ...
}
            </code>
        </pre>
    </section>

    <section>
        <h2>Register OSGi service mocks (2)</h2>

        <pre>
            <code data-trim class="java">
@Test
void 'Assert that the handleTransaction method is called'() {
    ...
    registerMock(paymentService)

    PizzaService pizzaService = getService(PizzaService)

    def pizza = PizzaBuilder.newPizza().withSauce(Sauce.BBQ).build()
    def customerInfo = new CustomerInfo("Max Mustermann", new Address(), 4242)
    pizzaService.placeOrder(new Order(pizza, customerInfo))

    assertThat transactionCalled, is(true)
}
            </code>
        </pre>
    </section>

    <section>
        <h2>OSGiTest.groovy</h2>

        <pre>
            <code data-trim class="java">
def registeredServices = [:]
protected abstract BundleContext getBundleContext()

def &lt;T&gt; T getService(Class&lt;T&gt; clazz){
    def serviceReference = bundleContext.getServiceReference(clazz.name)
    assertThat serviceReference, is(notNullValue())
    bundleContext.getService(serviceReference)
}

def registerMock(def mock, Hashtable properties = [:]) {
    def interfaceName = mock.class.interfaces?.find({it})?.name
    assertThat interfaceName, is(notNullValue())
    registeredServices.put(interfaceName,
    bundleContext.registerService(interfaceName, mock, properties))
}
    ...
            </code>
        </pre>
    </section>
</section>

<section>
    <section>
        <h1>Automation</h1><h2>with Maven and Tycho</h2>
    </section>

    <section>
        <h2>Tycho Groovy configuration (1)</h2>
        <h4>Groovy &amp; Maven<br> <a target="_blank" href="http://groovy.codehaus.org/Groovy-Eclipse+compiler+plugin+for+Maven">http://groovy.codehaus.org/Groovy-Eclipse+compiler+plugin+for+Maven</a></h4>
        <h4>Groovy Repository</h4>
        <pre>
        <code data-trim class="xml">
<repositories>
    ...
    <repository>
        <id>groovy-eclipse</id>
        <layout>p2</layout>
        <url>http://dist.springsource.org/release/GRECLIPSE/e4.3/</url>
    </repository>
</repositories>
            </code>
        </pre>
    </section>

    <section>
        <h2>Tycho Groovy configuration (2)</h2>
        <h4>Tycho, Groovy &amp; Surefire</h4>
        <pre>
            <code data-trim class="xml">
...
<plugin>
    <groupId>org.eclipse.tycho</groupId>
    <artifactId>tycho-surefire-plugin</artifactId>
    <version>${tycho.version}</version>
    <configuration>
        <includes>
            <include>**/*</include>
        </includes>
        ...
    </configuration>
</plugin>
...
            </code>
        </pre>
    </section>
</section>

<section>
        <h1>Conclusion</h1>
        <ul>
            <!-- should be improved -->
            <li>Add integrative Tests to your OSGi projects</li>
            <li>Easy to add groovy support in equinox and tycho</li>
            <li>Groovy makes developing tests more easier</li>
            <li>Powerful tests which run as fast as unit tests (>300 Tests in ~3 minutes)</li>
            <li>Fun!</li>
        </ul>
</section>
    
<section>
    <h1>Thank You!</h1>
    <p>Checkout "groovy" OSGi testing at github:</p>
    <pre>
        <code data-trim class="shell">
$ git clone https://github.com/groovyosgi/testing.git
$ cd testing
$ mvn clean install
        </code>
    </pre>

    <p>Lars Pfannenschmidt (Intuit, Inc.)</p>
    <p>Dennis Nobel (itemis AG)</p>
</section>
</div>
<p class="slidenumber" style="position: absolute; bottom: 15px; left: 15px;"></p>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.min.js"></script>

<script>

    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,
        width: 1200,
        height: 800,
        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'concave', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
            { src: 'lib/js/classList.js', condition: function () {
                return !document.body.classList;
            } },
            { src: 'plugin/markdown/marked.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            } },
            { src: 'plugin/markdown/markdown.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            } },
            { src: 'plugin/highlight/highlight.js', async: true, callback: function () {
                hljs.initHighlightingOnLoad();
            } },
            { src: 'plugin/zoom-js/zoom.js', async: true, condition: function () {
                return !!document.body.classList;
            } },
            { src: 'plugin/notes/notes.js', async: true, condition: function () {
                return !!document.body.classList;
            } },
            // Remote control your reveal.js presentation using a touch device
            //{ src: 'plugin/remotes/remotes.js', async: true, condition: function () {
            //  return !!document.body.classList;
            //  } }
        ]
    });

    function slidenumber(event) {
        var totalslides = document.querySelectorAll('.reveal .slides section:not(.stack)').length;
        var current_slide = 0;

        var horizontal_slides = document.querySelectorAll('.reveal .slides>section');
        for (var i = 0; i < event.indexh; i++) {
            // get subslides
            var subslides = horizontal_slides[i].querySelectorAll('section');

            // if subslides.length is 0, add 1 for horizontal slide, else add subslides.length
            current_slide += (subslides.length === 0) ? 1 : subslides.length;
        }

        current_slide += event.indexv + 1;
        return current_slide.toString() + "/" + totalslides.toString();
    }

    Reveal.addEventListener('slidechanged', function (event) {
        document.querySelector(".slidenumber").innerText = slidenumber(event);
    });
    Reveal.addEventListener('ready', function (event) {
        document.querySelector(".slidenumber").innerText = slidenumber(event);
    });

</script>

</body>
</html>
